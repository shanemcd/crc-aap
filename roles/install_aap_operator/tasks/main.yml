---
- name: Set derived variables
  ansible.builtin.set_fact:
    _aap_namespace: "{{ aap_namespace | default('aap' ~ (aap_version | replace('.', ''))) }}"
    _aap_operator_channel: "{{ aap_operator_channel | default('stable-' ~ aap_version) }}"

- name: Display installation parameters
  ansible.builtin.debug:
    msg:
      - "Installing AAP Operator version {{ aap_version }}"
      - "  Namespace: {{ _aap_namespace }}"
      - "  Channel: {{ _aap_operator_channel }}"
      - "  Source: {{ aap_operator_source }}"

- name: Create namespace for AAP
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ _aap_namespace }}"

- name: Create custom CatalogSource
  when: aap_custom_catalog_source_image is defined and aap_custom_catalog_source_image | length > 0
  block:
    - name: Display custom CatalogSource configuration
      ansible.builtin.debug:
        msg:
          - "Creating custom CatalogSource"
          - "  Name: {{ aap_custom_catalog_source_name }}"
          - "  Image: {{ aap_custom_catalog_source_image }}"

    - name: Create CatalogSource resource
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        state: present
        definition:
          apiVersion: operators.coreos.com/v1alpha1
          kind: CatalogSource
          metadata:
            name: "{{ aap_custom_catalog_source_name }}"
            namespace: openshift-marketplace
          spec:
            displayName: "{{ aap_custom_catalog_source_display_name }}"
            image: "{{ aap_custom_catalog_source_image }}"
            publisher: "{{ aap_custom_catalog_source_publisher }}"
            sourceType: grpc
            grpcPodConfig:
              securityContextConfig: restricted

    - name: Wait for CatalogSource to be ready
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        api_version: operators.coreos.com/v1alpha1
        kind: CatalogSource
        name: "{{ aap_custom_catalog_source_name }}"
        namespace: openshift-marketplace
      register: catalog_source_status
      until:
        - catalog_source_status.resources | length > 0
        - catalog_source_status.resources[0].status.connectionState.lastObservedState | default('') == 'READY'
      retries: 30
      delay: 5

    - name: Override operator source to use custom CatalogSource
      ansible.builtin.set_fact:
        aap_operator_source: "{{ aap_custom_catalog_source_name }}"
        aap_operator_source_namespace: openshift-marketplace

- name: Create OperatorGroup for AAP
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: aap-operator-group
        namespace: "{{ _aap_namespace }}"
      spec:
        targetNamespaces:
          - "{{ _aap_namespace }}"

- name: Create Subscription for AAP Operator
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: "{{ aap_operator_package }}"
        namespace: "{{ _aap_namespace }}"
      spec:
        channel: "{{ _aap_operator_channel }}"
        installPlanApproval: "{{ aap_operator_install_plan_approval }}"
        name: "{{ aap_operator_package }}"
        source: "{{ aap_operator_source }}"
        sourceNamespace: "{{ aap_operator_source_namespace }}"

- name: Check if CSV already exists and is ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ _aap_namespace }}"
    label_selectors:
      - "operators.coreos.com/{{ aap_operator_package }}.{{ _aap_namespace }}"
  register: existing_csv

- name: Approve InstallPlan for Manual approval mode
  when:
    - aap_operator_install_plan_approval == "Manual"
    - existing_csv.resources | length == 0 or existing_csv.resources[0].status.phase | default('') != "Succeeded"
  block:
    - name: Wait for InstallPlan to be created
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        api_version: operators.coreos.com/v1alpha1
        kind: InstallPlan
        namespace: "{{ _aap_namespace }}"
      register: install_plans
      until:
        - install_plans.resources | length > 0
        - install_plans.resources | selectattr('spec.approved', 'eq', false) | list | length > 0
      retries: 30
      delay: 5

    - name: Approve pending InstallPlan
      loop: "{{ install_plans.resources | selectattr('spec.approved', 'eq', false) | list }}"
      loop_control:
        label: "{{ item.metadata.name }}"
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        state: patched
        api_version: operators.coreos.com/v1alpha1
        kind: InstallPlan
        name: "{{ item.metadata.name }}"
        namespace: "{{ _aap_namespace }}"
        definition:
          spec:
            approved: true

- name: Wait for AAP Operator CSV to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig | default(omit) }}"
    api_version: operators.coreos.com/v1alpha1
    kind: ClusterServiceVersion
    namespace: "{{ _aap_namespace }}"
    label_selectors:
      - "operators.coreos.com/{{ aap_operator_package }}.{{ _aap_namespace }}"
  register: csv_status
  until:
    - csv_status.resources | length > 0
    - csv_status.resources[0].status.phase is defined
    - csv_status.resources[0].status.phase == "Succeeded"
  retries: 30
  delay: 10

- name: Display installation success
  ansible.builtin.debug:
    msg:
      - "AAP Operator installed successfully"
      - "  Namespace: {{ _aap_namespace }}"
      - "  CSV: {{ csv_status.resources[0].metadata.name }}"
      - "  Phase: {{ csv_status.resources[0].status.phase }}"
