---
- name: Build list of operator image overrides
  ansible.builtin.set_fact:
    _overrides: "{{ _operator_mappings | selectattr('var', 'ne', '') | list }}"

- name: Skip if no operator image overrides specified
  when: _overrides | length == 0
  ansible.builtin.debug:
    msg: "No operator image overrides specified, skipping"

- name: Apply operator image overrides
  when: _overrides | length > 0
  block:
    - name: Display overrides to apply
      ansible.builtin.debug:
        msg:
          - "Applying operator image overrides:"
          - "{{ _overrides | map(attribute='name') | list }}"

    - name: Get current deployment info
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        api_version: apps/v1
        kind: Deployment
        name: "{{ item.deployment }}"
        namespace: "{{ _aap_namespace }}"
      register: deployment_info

    - name: Initialize original data
      ansible.builtin.set_fact:
        _original_data: {}

    - name: Build original deployment data
      vars:
        _deploy: "{{ item.resources[0] }}"
        _containers: "{{ _deploy.spec.template.spec.containers }}"
        _entry:
          image: "{{ (_containers | selectattr('name', 'eq', item.item.container) | first).image }}"
          ownerReferences: "{{ _deploy.metadata.ownerReferences | default([]) }}"
          imagePullSecrets: "{{ _deploy.spec.template.spec.imagePullSecrets | default([]) }}"
      ansible.builtin.set_fact:
        _original_data: "{{ _original_data | combine({item.item.name: _entry}) }}"
      loop: "{{ deployment_info.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Save original data to ConfigMap
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: operator-image-overrides
            namespace: "{{ _aap_namespace }}"
          data:
            overrides: "{{ _original_data | to_json }}"

    - name: Check if image exists locally
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      containers.podman.podman_image_info:
        name: "{{ item.var }}"
      register: local_images

    - name: Pull images that don't exist locally
      loop: "{{ local_images.results }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: item.images | length == 0
      containers.podman.podman_image:
        name: "{{ item.item.var }}"
        state: present

    - name: Get OpenShift token for registry auth
      ansible.builtin.command:
        cmd: oc whoami -t
      register: oc_token
      changed_when: false

    - name: Push images to internal registry
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      containers.podman.podman_image:
        name: "{{ item.var }}"
        push: true
        push_args:
          dest: "{{ _external_registry }}/{{ _aap_namespace }}/{{ item.name }}-operator:override"
        username: unused
        password: "{{ oc_token.stdout }}"
        validate_certs: false

    - name: Grant image-puller role to operator ServiceAccounts
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: "{{ item.deployment }}-image-puller"
            namespace: "{{ _aap_namespace }}"
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:image-puller
          subjects:
            - kind: ServiceAccount
              name: "{{ item.deployment }}"
              namespace: "{{ _aap_namespace }}"

    - name: Remove ownerReferences from deployments (detach from OLM)
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      when: _original_data[item.name].ownerReferences | length > 0
      kubernetes.core.k8s_json_patch:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        api_version: apps/v1
        kind: Deployment
        name: "{{ item.deployment }}"
        namespace: "{{ _aap_namespace }}"
        patch:
          - op: remove
            path: /metadata/ownerReferences

    - name: Remove imagePullSecrets from deployments
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      when: _original_data[item.name].imagePullSecrets | length > 0
      kubernetes.core.k8s_json_patch:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        api_version: apps/v1
        kind: Deployment
        name: "{{ item.deployment }}"
        namespace: "{{ _aap_namespace }}"
        patch:
          - op: remove
            path: /spec/template/spec/imagePullSecrets

    - name: Patch deployment with internal registry image
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        state: present
        api_version: apps/v1
        kind: Deployment
        name: "{{ item.deployment }}"
        namespace: "{{ _aap_namespace }}"
        definition:
          spec:
            template:
              spec:
                containers:
                  - name: "{{ item.container }}"
                    image: "{{ _internal_registry }}/{{ _aap_namespace }}/{{ item.name }}-operator:override"
        merge_type: strategic-merge

    - name: Wait for deployments to be ready
      loop: "{{ _overrides }}"
      loop_control:
        label: "{{ item.name }}"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig | default(omit) }}"
        api_version: apps/v1
        kind: Deployment
        name: "{{ item.deployment }}"
        namespace: "{{ _aap_namespace }}"
      register: deploy_status
      until:
        - deploy_status.resources | length > 0
        - deploy_status.resources[0].status.readyReplicas is defined
        - deploy_status.resources[0].status.readyReplicas == deploy_status.resources[0].status.replicas
      retries: 30
      delay: 5

    - name: Display operator override success
      ansible.builtin.debug:
        msg:
          - "Operator image overrides applied:"
          - "{{ _overrides | map(attribute='name') | list }}"
