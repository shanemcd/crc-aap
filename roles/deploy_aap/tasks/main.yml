---
- name: Set derived variables
  ansible.builtin.set_fact:
    _aap_namespace: "{{ aap_namespace | default('aap' ~ (aap_version | replace('.', ''))) }}"

- name: Display deployment parameters
  ansible.builtin.debug:
    msg:
      - "Deploying AAP {{ aap_version }}"
      - "  Namespace: {{ _aap_namespace }}"
      - "  CR Name: {{ aap_cr_name }}"
      - "  Controller: {{ 'disabled' if aap_controller_disabled else 'enabled' }}"
      - "  EDA: {{ 'disabled' if aap_eda_disabled else 'enabled' }}"
      - "  Hub: {{ 'disabled' if aap_hub_disabled else 'enabled' }}"
      - "  Lightspeed: {{ 'disabled' if aap_lightspeed_disabled else 'enabled' }}"

- name: Verify chatbot configuration secret exists
  when: not aap_lightspeed_disabled
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    api_version: v1
    kind: Secret
    name: "{{ aap_lightspeed_chatbot_config_secret_name }}"
    namespace: "{{ _aap_namespace }}"
  register: chatbot_secret
  failed_when: chatbot_secret.resources | length == 0

- name: Create CA bundle secret for Lightspeed chatbot
  when:
    - not aap_lightspeed_disabled
    - aap_lightspeed_ca_bundle_secret_name | default('') | length > 0
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ aap_lightspeed_ca_bundle_secret_name }}"
        namespace: "{{ _aap_namespace }}"
      type: Opaque
      stringData:
        bundle-ca.crt: |
          {{ lookup('kubernetes.core.k8s', kind='ConfigMap', namespace=_aap_namespace, resource_name='openshift-service-ca.crt', kubeconfig=kubeconfig)['data']['service-ca.crt'] }}

- name: Deploy AnsibleAutomationPlatform CR
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: aap.ansible.com/v1alpha1
      kind: AnsibleAutomationPlatform
      metadata:
        name: "{{ aap_cr_name }}"
        namespace: "{{ _aap_namespace }}"
      spec:
        controller:
          disabled: "{{ aap_controller_disabled | bool }}"
          web_resource_requirements: "{{ aap_resource_requirements }}"
          task_resource_requirements: "{{ aap_resource_requirements }}"
          ee_resource_requirements: "{{ aap_resource_requirements }}"
          postgres_resource_requirements: "{{ aap_resource_requirements }}"
          redis_resource_requirements: "{{ aap_resource_requirements }}"
          rsyslog_resource_requirements: "{{ aap_resource_requirements }}"
          init_container_resource_requirements: "{{ aap_resource_requirements }}"
        eda:
          disabled: "{{ aap_eda_disabled | bool }}"
          activation_worker:
            resource_requirements: "{{ aap_resource_requirements }}"
          api:
            resource_requirements: "{{ aap_resource_requirements }}"
          default_worker:
            resource_requirements: "{{ aap_resource_requirements }}"
          event_stream:
            resource_requirements: "{{ aap_resource_requirements }}"
          database:
            resource_requirements: "{{ aap_resource_requirements }}"
          redis:
            resource_requirements: "{{ aap_resource_requirements }}"
          scheduler:
            resource_requirements: "{{ aap_resource_requirements }}"
          ui:
            resource_requirements: "{{ aap_resource_requirements }}"
        hub:
          disabled: "{{ aap_hub_disabled | bool }}"
          content:
            replicas: "{{ aap_hub_content_replicas }}"
            resource_requirements: "{{ aap_resource_requirements }}"
          file_storage_access_mode: "{{ aap_hub_file_storage_access_mode }}"
          file_storage_size: "{{ aap_hub_file_storage_size }}"
          file_storage_storage_class: "{{ aap_hub_file_storage_class | default(omit, true) }}"
          storage_type: "{{ aap_hub_storage_type }}"
          postgres_resource_requirements: "{{ aap_resource_requirements }}"
          redis_resource_requirements: "{{ aap_resource_requirements }}"
          api:
            resource_requirements: "{{ aap_resource_requirements }}"
          worker:
            resource_requirements: "{{ aap_resource_requirements }}"
          web:
            resource_requirements: "{{ aap_resource_requirements }}"
        lightspeed:
          disabled: "{{ aap_lightspeed_disabled | bool }}"
          chatbot_config_secret_name: "{{ aap_lightspeed_chatbot_config_secret_name }}"
          bundle_cacert_secret: "{{ aap_lightspeed_ca_bundle_secret_name | default(omit, true) }}"
          extra_settings: "{{ aap_lightspeed_extra_settings if aap_lightspeed_extra_settings | length > 0 else omit }}"
        no_log: "{{ aap_no_log }}"

- name: Display deployment information
  ansible.builtin.debug:
    msg:
      - "AnsibleAutomationPlatform '{{ aap_cr_name }}' has been deployed to namespace '{{ _aap_namespace }}'"
      - ""
      - "Monitor the deployment with:"
      - "  kubectl get pods -n {{ _aap_namespace }}"
      - "  kubectl get ansibleautomationplatform {{ aap_cr_name }} -n {{ _aap_namespace }}"
